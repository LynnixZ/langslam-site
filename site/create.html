<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Create Your Map Â· LangSLAM</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <main class="page">
      <nav class="nav"><a class="nav-logo" href="index.html">LangSLAM</a><div class="nav-links"><a class="" href="index.html">Overview</a><a class="" href="examples.html">Example Maps</a><a class="active" href="create.html">Create Your Map</a><a class="" href="results.html">LLM Results</a></div></nav>
      <header class="page-hero">
        <h1>Create Your Map</h1>
        <p class="lead">
          Configure a custom MiniGrid map, then run the generated command locally to produce a prompt,
          GIF, and ground-truth answer.
        </p>
        <p class="note">
          To generate results directly on this page, start the local server:
          <code>python site/server.py</code>
        </p>
      </header>

      <section class="section">
        <div class="form-card">
          <form id="mapForm" class="form-grid">
            <div class="form-field">
              <label for="mapType">Map Type</label>
              <select id="mapType">
                <option value="nowall">No Corridor (FlagsTightRoom)</option>
                <option value="corridor">Carved Corridor (CarvedPathRoom)</option>
              </select>
            </div>
            <div class="form-field">
              <label for="length">Room Length</label>
              <input id="length" type="number" min="5" max="30" value="10" />
            </div>
            <div class="form-field">
              <label for="viewSize">Agent View Size</label>
              <input id="viewSize" type="number" min="3" max="9" value="5" />
            </div>
            <div class="form-field">
              <label for="episodes">Episodes</label>
              <input id="episodes" type="number" min="1" max="50" value="1" />
            </div>
            <div class="form-field">
              <label for="flags">Flags</label>
              <input id="flags" type="number" min="0" max="30" value="6" />
            </div>
            <div class="form-field">
              <label for="movable">Moving Objects</label>
              <input id="movable" type="number" min="0" max="10" value="1" />
            </div>
            <div class="form-field form-field-wide">
              <label for="outDir">Output Directory</label>
              <input id="outDir" type="text" value="mapdata/custom_runs" />
            </div>
          </form>

          <details class="panel" open>
            <summary>Noise Settings</summary>
            <div class="panel-body form-grid">
              <div class="form-field">
                <label for="pJump">p_jump</label>
                <input id="pJump" type="number" step="0.01" min="0" max="1" value="0" />
              </div>
              <div class="form-field">
                <label for="pFail">p_fail</label>
                <input id="pFail" type="number" step="0.01" min="0" max="1" value="0" />
              </div>
              <div class="form-field">
                <label for="muD">mu_d</label>
                <input id="muD" type="number" step="0.01" min="0" max="1" value="0" />
              </div>
              <div class="form-field">
                <label for="muS">mu_s</label>
                <input id="muS" type="number" step="0.01" min="0" max="1" value="0" />
              </div>
              <div class="form-field">
                <label class="checkbox">
                  <input id="blackout" type="checkbox" />
                  Blackout
                </label>
              </div>
            </div>
          </details>

          <details class="panel" open>
            <summary>Corridor Width Settings (CarvedPathRoom)</summary>
            <div class="panel-body form-grid" id="corridorSettings">
              <div class="form-field">
                <label for="segBand">seg_band</label>
                <input id="segBand" type="number" min="1" max="5" value="1" />
              </div>
              <div class="form-field">
                <label for="segLeft">seg_prob_left</label>
                <input id="segLeft" type="number" step="0.1" min="0" max="1" value="0.2" />
              </div>
              <div class="form-field">
                <label for="segRight">seg_prob_right</label>
                <input id="segRight" type="number" step="0.1" min="0" max="1" value="0.2" />
              </div>
              <div class="form-field">
                <label for="segTrim">seg_end_trim</label>
                <input id="segTrim" type="number" min="0" max="3" value="1" />
              </div>
              <div class="form-field">
                <label for="segSkip">seg_skip_prob</label>
                <input id="segSkip" type="number" step="0.1" min="0" max="1" value="0" />
              </div>
              <div class="form-field">
                <label class="checkbox">
                  <input id="postFillDisable" type="checkbox" checked />
                  Disable post-fill (narrower corridor)
                </label>
              </div>
            </div>
          </details>

          <div class="form-actions">
            <button class="btn" type="button" id="generateBtn">Generate Command</button>
            <button class="btn ghost" type="button" id="copyBtn">Copy Command</button>
            <button class="btn" type="button" id="runBtn">Run Locally</button>
          </div>
        </div>
      </section>

      <section class="section">
        <div class="detail-block">
          <h3>Run Locally</h3>
          <div class="prompt-box"><pre id="commandOutput"></pre></div>
          <p class="note">Run this command in your terminal from the Minigrid folder.</p>
        </div>
        <div class="detail-block">
          <h3>Expected Outputs</h3>
          <ul class="output-list" id="outputList"></ul>
          <p class="note">
            The YAML file includes the prompt text and the ground-truth answer.
          </p>
        </div>
      </section>
      <section class="section">
        <div class="detail-block">
          <h3>Generated Result</h3>
          <div class="result-grid">
            <div class="result-media">
              <img id="resultGif" alt="Generated map GIF preview" />
            </div>
            <div class="result-meta">
              <h4>Key Properties</h4>
              <dl id="resultProps"></dl>
              <h4>Correct Answer</h4>
              <p id="resultAnswer" class="answer-text"></p>
            </div>
          </div>
          <div class="detail-block">
            <h4>Prompt</h4>
            <div class="prompt-box"><pre id="resultPrompt"></pre></div>
          </div>
        </div>
      </section>
      <script>
        const byId = (id) => document.getElementById(id);
        const mapType = byId('mapType');
        const corridorSettings = byId('corridorSettings');
        const commandOutput = byId('commandOutput');
        const outputList = byId('outputList');
        const resultGif = byId('resultGif');
        const resultPrompt = byId('resultPrompt');
        const resultAnswer = byId('resultAnswer');
        const resultProps = byId('resultProps');

        function updateVisibility() {
          const corridor = mapType.value === 'corridor';
          corridorSettings.closest('details').open = corridor;
          corridorSettings.closest('details').style.opacity = corridor ? '1' : '0.4';
        }

        function buildPayload() {
          const corridor = mapType.value === 'corridor';
          const length = Number(byId('length').value || 10);
          const view = Number(byId('viewSize').value || 5);
          const episodes = Number(byId('episodes').value || 1);
          const flags = Number(byId('flags').value || 0);
          const movable = Number(byId('movable').value || 0);
          const outDir = (byId('outDir').value || 'mapdata/custom_runs').trim();

          return {
            mapType: corridor ? 'corridor' : 'nowall',
            length,
            viewSize: view,
            episodes,
            flags,
            movable,
            outDir,
            pJump: byId('pJump').value || 0,
            pFail: byId('pFail').value || 0,
            muD: byId('muD').value || 0,
            muS: byId('muS').value || 0,
            blackout: byId('blackout').checked,
            segBand: byId('segBand').value,
            segLeft: byId('segLeft').value,
            segRight: byId('segRight').value,
            segTrim: byId('segTrim').value,
            segSkip: byId('segSkip').value,
            postFillDisable: byId('postFillDisable').checked,
          };
        }

        function buildCommand() {
          const payload = buildPayload();
          const corridor = payload.mapType === 'corridor';
          const envName = corridor ? 'MiniGrid-CarvedPathRoom-v0' : 'MiniGrid-FlagsTightRoom-v0';
          const promptEnv = envName;
          const length = payload.length;
          const view = payload.viewSize;
          const episodes = payload.episodes;
          const flags = payload.flags;
          const movable = payload.movable;
          const outDir = payload.outDir;

          const pJump = payload.pJump;
          const pFail = payload.pFail;
          const muD = payload.muD;
          const muS = payload.muS;
          const blackout = payload.blackout;

          const parts = [
            'python -m map_main.make_episodes',
            `--env_name ${envName}`,
            `--prompt_env_names ${promptEnv}`,
            `--num_episodes ${episodes}`,
            `--length ${length}`,
            `--agent_view_size ${view}`,
            `--flags ${flags}`,
            '--noise_log',
            `--p_jump ${pJump}`,
            `--p_fail ${pFail}`,
            `--mu_d ${muD}`,
            `--mu_s ${muS}`,
            `--movable_goals ${movable}`,
            `--out_dir ${outDir}`,
          ];

          if (blackout) parts.push('--blackout');

          if (corridor) {
            parts.push(`--seg_band ${payload.segBand}`);
            parts.push(`--seg_prob_left ${payload.segLeft}`);
            parts.push(`--seg_prob_right ${payload.segRight}`);
            parts.push(`--seg_end_trim ${payload.segTrim}`);
            parts.push(`--seg_skip_prob ${payload.segSkip}`);
            if (payload.postFillDisable) parts.push('--post_fill_disable');
          }

          const cmd = `cd /Users/zouqueling/Desktop/enbodiedAI/Minigrid\\n${parts.join(' ')}`;
          commandOutput.textContent = cmd;

          const safe = promptEnv.replace(/\\//g, '-');
          const autoDir = `${safe}-L${length}-V${view}-E${episodes}-F${flags}`;
          const baseDir = `${outDir}/${autoDir}`;
          const gifPath = corridor
            ? `${baseDir}/ep_00000_main_trace.gif`
            : `${baseDir}/flags/ep_00000_flags_trace.gif`;
          const yamlPath = corridor
            ? `${baseDir}/ep_00000_main_prompt.yaml`
            : `${baseDir}/flags/ep_00000_flags_prompt.yaml`;
          const manifestPath = `${baseDir}/manifest_prompt.json`;

          outputList.innerHTML = `
            <li><strong>GIF</strong>: ${gifPath}</li>
            <li><strong>Prompt + Answer</strong>: ${yamlPath}</li>
            <li><strong>Manifest</strong>: ${manifestPath}</li>
          `;
        }

        async function runLocally() {
          const payload = buildPayload();
          resultAnswer.textContent = 'Running...';
          resultPrompt.textContent = '';
          resultProps.innerHTML = '';
          resultGif.removeAttribute('src');

          try {
            if (window.location.protocol === 'file:') {
              throw new Error('Open via http://127.0.0.1:8000/create.html (run: python site/server.py).');
            }
            const res = await fetch('/api/generate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload),
            });
            const text = await res.text();
            let data = {};
            if (text) {
              try {
                data = JSON.parse(text);
              } catch (err) {
                throw new Error('Server returned non-JSON. Use: python site/server.py');
              }
            }
            if (!res.ok) {
              throw new Error(data.error || `Server error (${res.status})`);
            }

            resultGif.src = data.gif_url;
            resultPrompt.textContent = data.prompt || '';
            resultAnswer.textContent = data.answer || '';
            const props = data.properties || {};
            resultProps.innerHTML = Object.entries(props)
              .map(([k, v]) => `<dt>${k}</dt><dd>${v}</dd>`)
              .join('');
          } catch (err) {
            const msg = err && err.message ? err.message : 'Unknown error';
            const extra = msg.includes('Failed to fetch')
              ? ' (start the server: python site/server.py)'
              : '';
            resultAnswer.textContent = `Error: ${msg}${extra}`;
          }
        }

        function copyCommand() {
          const text = commandOutput.textContent;
          navigator.clipboard.writeText(text);
        }

        byId('generateBtn').addEventListener('click', buildCommand);
        byId('copyBtn').addEventListener('click', copyCommand);
        byId('runBtn').addEventListener('click', runLocally);
        mapType.addEventListener('change', updateVisibility);

        updateVisibility();
        buildCommand();
      </script>
    </main>
  </body>
</html>
